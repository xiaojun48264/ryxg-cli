import{execSync as R,spawn as g}from"node:child_process";import{writeFileSync as L,existsSync as C,mkdirSync as x,createWriteStream as B}from"node:fs";import{tmpdir as d,platform as h}from"node:os";import{ERROR_PREFIX as G,INFO_PREFIX as F,WARN_PREFIX as P,SUCCESS_PREFIX as w}from"../ui/prefixes.mjs";import D from"dayjs";import y from"node:path";import f from"tree-kill";import{getUTF8Str as A}from"./tools.mjs";const p=`${d().replace(/\\/g,"/")}/ry-cli/logs`,l=y.resolve(p,"logs.log"),U={ERROR:G,INFO:F,WARN:P,SUCCESS:w};function S(){C(p)||x(p,{recursive:!0})}function M(t="\u9879\u76EE\u65E5\u5FD7"){I();const e=h();let r="",o=[];switch(e){case"win32":r="cmd.exe",o=["/c","start",`"${t}"`,"powershell.exe","-NoExit","-Command",`Get-Content -Path '${l}' -Wait -Encoding UTF8`];break;case"darwin":r="osascript",o=["-e",`tell application "Terminal" to do script "tail -f ${l}"`];break;case"linux":r="xterm",o=["-e",`tail -f ${l}`];break}if(r){const E=m(["cmd.exe","powershell.exe"]);g(r,o,{shell:e==="win32"});let n=[];setTimeout(()=>{n=m(["cmd.exe","powershell.exe"]).filter(s=>!E.includes(s))},1e3),process.on("exit",()=>{n.forEach(s=>{f(s)})}),process.on("SIGINT",()=>{n.forEach(s=>{f(s)}),process.exit(1)}),process.on("SIGTERM",()=>{n.forEach(s=>{f(s)}),process.exit(1)})}}function m(t){const e=R("tasklist /fo csv /nh"),r=[],o=A(e).split(`\r
`);for(let E of o){const n=E.split('","');if(n.length>=2){const s=n[0].replace('"',""),a=n[1].replace('"',"");t.includes(s)&&r.push(parseInt(a))}}return r}function I(){S(),L(l,"","utf-8")}function u(t,e){const r=e.toUpperCase(),o=U[r],E=D().format("YYYY-MM-DD HH:mm:ss");return`${o} ${E} ${t}`}function T(t,e){B(l,{flags:"a"}).write(`${u(t,e)}
`)}function $(t,e){console.log(`
${u(t,e)}`)}function W(t){if(typeof t!="string")return JSON.stringify(t);let e=t;const r=["[ERROR] :","[LOG] :","[INFO] :","[WARN] :"];for(let o of r)if(t.startsWith(o)){e=t.replace(o,"");break}return e}function X(t){let e="info";return t.startsWith("[ERROR] :")?e="error":t.startsWith("[WARN] :")&&(e="warn"),e}const i=new Map;function k(t){let e=t;return i.size===0&&(i.set("---BEGIN:JSON---",c("Object","---BEGIN:JSON---","","---END:JSON---",!1,!1)),i.set("---BEGIN:CONSOLE---",c("CONSOLE","---BEGIN:CONSOLE---","","---END:CONSOLE---",!1,!1)),i.set("---BEGIN:NUMBER---",c("Number","---BEGIN:NUMBER---","","---END:NUMBER---",!1,!0)),i.set("---BEGIN:EXCEPTION---",c("EXCEPTION","---BEGIN:EXCEPTION---","","---END:EXCEPTION---",!1,!0)),i.set("---BEGIN:BOOLEAN---",c("Boolean","---BEGIN:BOOLEAN---","","---END:BOOLEAN---",!1,!0)),i.set("---NULL---",c("","---NULL---","null","",!0,!0)),i.set("---UNDEFINED---",c("","---UNDEFINED---","undefined","",!0,!0)),i.set("---COMMA---",c("","---COMMA---",", ","",!0,!0)),i.set("---BEGIN:CLASS---",c("Class","---BEGIN:CLASS---","","---END:CLASS---",!1,!0))),i.forEach(function(r,o){if(e.indexOf(o)>=0){const{startPrefix:E,endPrefix:n,type:s,replaceContent:a}=r;let O="["+s+"]";s==""&&(O=a);let N=e.replace(new RegExp(E,"g"),O+" ");n!=""&&(N=N.replace(new RegExp(n,"g")," ")),e=N}}),e=e.trim(),e}function c(t,e,r,o,E=!1,n=!1){return{startPrefix:e||"",endPrefix:o||"",replaceContent:r||"",type:t||"",isReplace:E,isStype:n}}export{S as checkLogs,I as clearLogs,c as createReplaceInfo,u as formatLog,k as getFormatLine,W as getLogStrNoLevel,X as getLogType,m as getPidByProcessName,$ as printLog,T as printLogConSole,M as runLogs};
