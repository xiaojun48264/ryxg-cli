import{execSync as R,spawn as g}from"node:child_process";import{writeFileSync as L,existsSync as C,mkdirSync as x,createWriteStream as B}from"node:fs";import{tmpdir as d,platform as h}from"node:os";import{ERROR_PREFIX as G,INFO_PREFIX as P,WARN_PREFIX as w,SUCCESS_PREFIX as F}from"../ui/prefixes.mjs";import y from"dayjs";import A from"node:path";import f from"tree-kill";import{getUTF8Str as D}from"./tools.mjs";const p=`${d().replace(/\\/g,"/")}/ry-cli/logs`,l=A.resolve(p,"logs.log"),U={ERROR:G,INFO:P,WARN:w,SUCCESS:F};function u(){C(p)||x(p,{recursive:!0})}function M(){I();const t=h();let e="",o=[];switch(t){case"win32":e="cmd.exe",o=["/c","start","cmd.exe","/k",`powershell.exe -NoExit -Command "Get-Content -Path '${l}' -Wait -Encoding UTF8"`];break;case"darwin":e="osascript",o=["-e",`tell application "Terminal" to do script "tail -f ${l}"`];break;case"linux":e="xterm",o=["-e",`tail -f ${l}`];break}if(e){const n=m(["cmd.exe","powershell.exe"]);g(e,o,{shell:t==="win32"});let s=[];setTimeout(()=>{s=m(["cmd.exe","powershell.exe"]).filter(r=>!n.includes(r))},1e3),process.on("exit",()=>{s.forEach(r=>{f(r)})}),process.on("SIGINT",()=>{s.forEach(r=>{f(r)}),process.exit(1)}),process.on("SIGTERM",()=>{s.forEach(r=>{f(r)}),process.exit(1)})}}function m(t){const e=R("tasklist /fo csv /nh"),o=[],n=D(e).split(`\r
`);for(let s of n){const r=s.split('","');if(r.length>=2){const E=r[0].replace('"',""),a=r[1].replace('"',"");t.includes(E)&&o.push(parseInt(a))}}return o}function I(){u(),L(l,"","utf-8")}function O(t,e){const o=e.toUpperCase(),n=U[o],s=y().format("YYYY-MM-DD HH:mm:ss");return`${n} ${s} ${t}`}function T(t,e){B(l,{flags:"a"}).write(`${O(t,e)}
`)}function W(t,e){console.log(`
${O(t,e)}`)}function $(t){if(typeof t!="string")return JSON.stringify(t);let e=t;const o=["[ERROR] :","[LOG] :","[INFO] :","[WARN] :"];for(let n of o)if(t.startsWith(n)){e=t.replace(n,"");break}return e}function k(t){let e="info";return t.startsWith("[ERROR] :")?e="error":t.startsWith("[WARN] :")&&(e="warn"),e}const i=new Map;function X(t){let e=t;return i.size===0&&(i.set("---BEGIN:JSON---",c("Object","---BEGIN:JSON---","","---END:JSON---",!1,!1)),i.set("---BEGIN:CONSOLE---",c("CONSOLE","---BEGIN:CONSOLE---","","---END:CONSOLE---",!1,!1)),i.set("---BEGIN:NUMBER---",c("Number","---BEGIN:NUMBER---","","---END:NUMBER---",!1,!0)),i.set("---BEGIN:EXCEPTION---",c("EXCEPTION","---BEGIN:EXCEPTION---","","---END:EXCEPTION---",!1,!0)),i.set("---BEGIN:BOOLEAN---",c("Boolean","---BEGIN:BOOLEAN---","","---END:BOOLEAN---",!1,!0)),i.set("---NULL---",c("","---NULL---","null","",!0,!0)),i.set("---UNDEFINED---",c("","---UNDEFINED---","undefined","",!0,!0)),i.set("---COMMA---",c("","---COMMA---",", ","",!0,!0)),i.set("---BEGIN:CLASS---",c("Class","---BEGIN:CLASS---","","---END:CLASS---",!1,!0))),i.forEach(function(o,n){if(e.indexOf(n)>=0){const{startPrefix:s,endPrefix:r,type:E,replaceContent:a}=o;let S="["+E+"]";E==""&&(S=a);let N=e.replace(new RegExp(s,"g"),S+" ");r!=""&&(N=N.replace(new RegExp(r,"g")," ")),e=N}}),e=e.trim(),e}function c(t,e,o,n,s=!1,r=!1){return{startPrefix:e||"",endPrefix:n||"",replaceContent:o||"",type:t||"",isReplace:s,isStype:r}}export{u as checkLogs,I as clearLogs,c as createReplaceInfo,O as formatLog,X as getFormatLine,$ as getLogStrNoLevel,k as getLogType,m as getPidByProcessName,W as printLog,T as printLogConSole,M as runLogs};
